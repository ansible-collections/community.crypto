---
####################################################################
# WARNING: These are designed specifically for Ansible tests       #
# and should not be used as examples of how to write Ansible roles #
####################################################################

- name: Point to OpenSSL binary
  set_fact:
    openssl_binary: openssl

- name: register openssl version (full)
  shell: "{{ openssl_binary }} version"
  register: openssl_version_full

- name: show openssl version (full)
  debug:
    var: openssl_version_full.stdout_lines

- when: ansible_os_family == "Darwin" and "LibreSSL" in openssl_version_full.stdout
  # In case LibreSSL is installed on macOS, we need to install a more modern OpenSSL
  block:
    - name: MACOS | Find brew binary
      command: which brew
      register: brew_which

    - name: MACOS | Get owner of brew binary
      stat:
        path: "{{ brew_which.stdout }}"
      register: brew_stat

    - name: MACOS | Install openssl
      community.general.homebrew:
        name: openssl
        state: present
      become: yes
      become_user: "{{ brew_stat.stat.pw_name }}"

    - name: MACOS | Locale openssl binary
      command: brew --prefix openssl
      register: brew_openssl_prefix

    - name: MACOS | Point to OpenSSL binary
      set_fact:
        openssl_binary: "{{ brew_openssl_prefix.stdout }}/bin/openssl"

    - name: MACOS | Register openssl version (full)
      shell: "{{ openssl_binary }} version"
      register: openssl_version_full_again
      # We must use a different variable to prevent the 'when' condition of the surrounding block to fail

    - name: MACOS | Show openssl version (full)
      debug:
        var: openssl_version_full_again.stdout_lines
