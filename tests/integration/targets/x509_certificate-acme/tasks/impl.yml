---
- name: Generate account key
  openssl_privatekey:
    path: '{{ output_dir }}/account.key'
    size: 2048

- name: Generate privatekey
  openssl_privatekey:
    path: '{{ output_dir }}/privatekey.pem'
    size: 2048

- name: Generate CSRs
  openssl_csr:
    privatekey_path: '{{ output_dir }}/privatekey.pem'
    path: '{{ output_dir }}/{{ item.name }}.csr'
    subject_alt_name: '{{ item.sans }}'
  loop:
  - name: cert-1
    sans:
      - DNS:example.com
  - name: cert-2
    sans:
      - DNS:example.com
      - DNS:example.org

- name: Retrieve certificate 1
  x509_certificate:
    provider: acme
    path: '{{ output_dir }}/cert-1.pem'
    csr_path: '{{ output_dir }}/cert-1.csr'
    acme_accountkey_path: '{{ output_dir }}/account.key'
    acme_challenge_path: '{{ output_dir }}/challenges/'
    acme_directory: https://{{ acme_host }}:14000/dir
  environment:
    PATH: '{{ lookup("env", "PATH") }}:{{ output_dir }}'

- name: Get certificate information
  x509_certificate_info:
    path: '{{ output_dir }}/cert-1.pem'
  register: result

- name: Validate certificate information
  assert:
    that:
      - result.subject_alt_name | length == 1
      - "'DNS:example.com' in result.subject_alt_name"

- name: Retrieve certificate 2
  x509_certificate:
    provider: acme
    path: '{{ output_dir }}/cert-2.pem'
    csr_path: '{{ output_dir }}/cert-2.csr'
    acme_accountkey_path: '{{ output_dir }}/account.key'
    acme_challenge_path: '{{ output_dir }}/challenges/'
    acme_directory: https://{{ acme_host }}:14000/dir
  environment:
    PATH: '{{ lookup("env", "PATH") }}:{{ output_dir }}'

- name: Get certificate information
  x509_certificate_info:
    path: '{{ output_dir }}/cert-2.pem'
  register: result

- name: Validate certificate information
  assert:
    that:
      - result.subject_alt_name | length == 2
      - "'DNS:example.com' in result.subject_alt_name"
      - "'DNS:example.org' in result.subject_alt_name"
